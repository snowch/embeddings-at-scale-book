name: Code Quality

on:
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'code_examples/**/*.py'
      - 'pyproject.toml'
      - '.github/workflows/code-quality.yml'
  pull_request:
    paths:
      - 'code_examples/**/*.py'
      - 'pyproject.toml'
      - '.github/workflows/code-quality.yml'
  workflow_dispatch:

jobs:
  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install ruff
        run: |
          pip install ruff==0.1.9

      - name: Run ruff linter
        run: |
          ruff check code_examples/ --output-format=github

      - name: Run ruff formatter check
        run: |
          ruff format --check code_examples/

  syntax-check:
    name: Python Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Compile all Python files
        run: |
          set -e
          total=0
          errors=0

          echo "ğŸ” Checking Python syntax..."
          echo ""

          for file in $(find code_examples -name "*.py" -type f); do
            total=$((total + 1))
            if ! python3 -m py_compile "$file" 2>/dev/null; then
              echo "âŒ SYNTAX ERROR: $file"
              python3 -m py_compile "$file" 2>&1 || true
              errors=$((errors + 1))
            fi
          done

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Syntax Check Results:"
          echo "   Total files: $total"
          echo "   Files with errors: $errors"
          echo "   Success rate: $(( (total - errors) * 100 / total ))%"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ $errors -gt 0 ]; then
            echo ""
            echo "âŒ FAILED: $errors file(s) have syntax errors"
            exit 1
          else
            echo ""
            echo "âœ… SUCCESS: All files compile successfully!"
          fi

  dependencies-check:
    name: Check Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Verify requirements.txt exists
        run: |
          if [ ! -f "code_examples/requirements.txt" ]; then
            echo "âŒ ERROR: code_examples/requirements.txt not found"
            exit 1
          fi
          echo "âœ… requirements.txt found"

      - name: Test requirements installation
        run: |
          pip install -r code_examples/requirements.txt
          echo "âœ… All dependencies install successfully"

  report:
    name: Generate Quality Report
    runs-on: ubuntu-latest
    needs: [lint, syntax-check, dependencies-check]
    if: always()

    steps:
      - name: Report Results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Code Quality Report"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Linting: ${{ needs.lint.result }} (required)"
          echo "Syntax Check: ${{ needs.syntax-check.result }} (required)"
          echo "Dependencies: ${{ needs.dependencies-check.result }} (required)"
          echo ""

          # Check all required jobs
          if [ "${{ needs.lint.result }}" = "success" ] && \
             [ "${{ needs.syntax-check.result }}" = "success" ] && \
             [ "${{ needs.dependencies-check.result }}" = "success" ]; then
            echo "âœ… All required checks passed!"
          else
            echo "âŒ One or more required checks failed"
            exit 1
          fi
